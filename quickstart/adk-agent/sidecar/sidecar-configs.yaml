apiVersion: v1
kind: ConfigMap
metadata:
  name: sidecar-envoy-configs
  namespace: quickstart-ns
data:
  envoy.yaml: |
    # When Envoy uses the SDS API (even for local files), it needs to identify itself.
    # This "node identity" is used for logging, metrics, and in more advanced scenarios, for fetching secrets from a remote management server.
    # Even though we're using local files, the API structure still requires this identification. It doesn't know which Envoy is asking for the secret otherwise.
    node:
      id: "envoy-sidecar-node"
      cluster: "envoy-sidecar-cluster"

    static_resources:
      listeners:
      - name: listener_0
        address:
          socket_address:
            address: 0.0.0.0
            port_value: 10001
        filter_chains:
          - filters:
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: tcp
                cluster: envoy-gateway
      clusters:
      - name: envoy-gateway
        type: LOGICAL_DNS
        load_assignment:
          cluster_name: envoy-gateway
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    # This is the address of the KAN gateway.
                    # It will be dynamically injected from the Gateway status.
                    address: ${GATEWAY_ADDRESS}
                    port_value: 10001
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
            common_tls_context:
              tls_certificate_sds_secret_configs:
              - name: "spiffe_identity"
                sds_config:
                  resource_api_version: V3
                  path_config_source:
                    path: "/etc/envoy/sds/spiffe_identity.yaml"
              combined_validation_context:
                default_validation_context:
                  # This ensures Envoy only connects to a server with this specific identity.
                  # It will be dynamically injected based on the Gateway hash.
                  match_typed_subject_alt_names:
                  - san_type: URI
                    matcher:
                      exact: "${GATEWAY_SPIFFE_ID}"
                validation_context_sds_secret_config:
                  name: "spiffe_trust"
                  sds_config:
                    resource_api_version: V3
                    path_config_source:
                      path: "/etc/envoy/sds/spiffe_trust.yaml"

    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9002

  spiffe_identity.yaml: |
    resources:
    - "@type": "type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret"
      name: "spiffe_identity"
      tls_certificate:
        certificate_chain:
          filename: "/run/agent-identity-mtls/credential-bundle.pem"
        private_key:
          filename: "/run/agent-identity-mtls/credential-bundle.pem"

  spiffe_trust.yaml: |
    resources:
    - "@type": "type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret"
      name: "spiffe_trust"
      validation_context:
        trusted_ca:
          filename: "/run/agent-identity-mtls/cluster.local.trust-bundle.pem"
